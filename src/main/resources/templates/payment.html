<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(
          title='Pago - Chuponcito',
          cssFile='/css/style_payment.css',
          activePage='pago',
          searchPlaceholder='Buscar pago...',
          content=~{::content})}">

<body>
  <div th:fragment="content">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-md-6 text-center">
          <h2 class="fw-bold mb-4">Procesando Pago</h2>
          <div class="spinner-border text-warning mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="lead" th:if="${session.paymentType}">Simulando transacción con <strong th:text="${session.paymentType}"></strong>. ¡Tu pizza está en camino!</p>
          <p class="lead" th:unless="${session.paymentType}">Simulando transacción segura. No te muevas, ¡tu pizza está en camino!</p>
          <div id="paymentStatus" class="mt-4">
            <p class="text-muted">Verificando <strong th:text="${session.paymentType}"></strong>....</p>
          </div>
          <div id="successMessage" class="d-none alert alert-success mt-4">
            <h4>¡Pago Exitoso!</h4>
            <p>Tu orden ha sido confirmada. Te enviaremos el número de seguimiento pronto.</p>
            <a href="/" class="btn btn-accion">Volver al Inicio</a>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
  console.log("Script de payment.html cargado");
  
  function simulatePayment() {
    console.log("simulatePayment() iniciada");
    const status = document.getElementById('paymentStatus');
    const success = document.getElementById('successMessage');
    
    if (!status) {
      console.error("No se encontró elemento #paymentStatus");
      return;
    }
    if (!success) {
      console.error("No se encontró elemento #successMessage");
      return;
    }
    
    const messages = [
      'Verificando tarjeta...',
      'Autorizando pago...',
      'Procesando orden...',
      '¡Listo!'
    ];
    let i = 0;
    
    // Mostrar primer mensaje inmediatamente
    status.innerHTML = `<p class="text-muted">${messages[0]}</p>`;
    i++;

    const interval = setInterval(() => {
      if (i >= messages.length) {
        clearInterval(interval);
        console.log("Simulación terminada. Iniciando finalización de orden...");
        
        // Llama API para finalizar orden
        const payload = {
            address: /*[[${checkoutAddress ?: 'Dirección default'}]]*/ 'Dirección default',
            phone: /*[[${checkoutPhone ?: 'Teléfono default'}]]*/ 'Teléfono default',
            notes: /*[[${checkoutNotes ?: ''}]]*/ '',
            paymentType: /*[[${paymentType ?: 'Efectivo'}]]*/ 'Efectivo'
        };
        console.log("Payload:", payload);

        fetch('/api/cart/finalizeOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r => {
            console.log("Respuesta status:", r.status);
            return r.json();
        }).then(data => {
          console.log("Data:", data);
          if (data.error) {
             status.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
          } else {
             status.innerHTML = `<p class="text-success">${data.message}</p>`;
             success.classList.remove('d-none');
             // Redirigir después de 3 segundos
             setTimeout(() => {
               console.log("Redirigiendo a confirmación...");
               window.location.href = `/order-confirmation?orderId=${data.orderId}`;
             }, 3000);
          }
        }).catch(err => {
          console.error("Fetch error:", err);
          status.innerHTML = `<p class="text-danger">Error de conexión: ${err}</p>`;
        });
      } else {
        status.innerHTML = `<p class="text-muted">${messages[i]}</p>`;
        i++;
      }
    }, 1500);
  }
  
  // Ejecutar automáticamente cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', simulatePayment);
  } else {
    // DOM ya está listo, ejecutar inmediatamente
    simulatePayment();
  }
</script>
  </div>
</body>
</html>